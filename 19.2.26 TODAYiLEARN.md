# 19.2.26 TODAYiLEARN





## -GetLastError API

: 에러를 가져옵니다.

많은 시스템 기능들이 실패한다면 마지막 오류 코드가 설정됩니다. 응용 프로그램에서 오류에 대한 자세한 정보가 필요하면 GetLastError 함수를 사용하여 마지막 오류 코드를 검색하고 FormatMessage 함수를 사용하여 오류에 대한 설명을 표시 할 수 있습니다.



인자 값

```
Declare Function GetLastError Lib "Kernel32" Alias "GetLastError" () As Long
```

보시는거와 같이 인자값이 하나도 없습니다. 

결국 반환 값만 줍니다.(반환값 = 에러값)



반환 종류는 0~15999 에러가 있습니다.

그러니깐 에러가 나면 그때 그때 반환해 줍니다.

https://docs.microsoft.com/ko-kr/windows/desktop/Debug/system-error-codes

이 링크를 들어가면 윈도우 에러를 볼 수 있습니다.



## -잘못된 디렉터리 생성 오류코드를 메세지로 변환하는 코드

예시로 C#으로 디렉터리 생성하는 코드

```C#
using System;
using System.Runtime.InteropServices;

namespace ApiReference
{
    class ApiExample
    {
        [DllImport("kernel32", CharSet = CharSet.Auto)]
        public static extern Int32 CreateDirectory(String PathName, IntPtr SecAttr);

        public static void Main(String[] args)
        {
            Int32 result = CreateDirectory(@"C:\h?ell*o? worl\\ld\\\\\\d\d\d?", IntPtr.Zero);
            Console.WriteLine("폴더 만들기 결과 : {0}", result);
            Console.ReadKey(true);

        }
    }
}
```



출력 결과 아무 반응도 일어나지 않습니다.  -> API호출에 실패...

CreateDirectory 함수에 Path가 올바르지 않기 때문입니다. 



위에 코드에 아래의 API GetLastError을 추가해줍니다.

```c#
  [DllImport("kernel32", CharSet = CharSet.Auto)]
        public static extern Int32 GetLastError();
```



```c#
using System;
using System.Runtime.InteropServices;

namespace ApiReference
{
    class ApiExample
    {
        [DllImport("kernel32", CharSet = CharSet.Auto)]
        public static extern Int32 CreateDirectory(String PathName, IntPtr SecAttr);
        [DllImport("kernel32", CharSet = CharSet.Auto)]
        public static extern Int32 GetLastError();

        public static void Main(String[] args)
        {
            Int32 result = CreateDirectory(@"C:\h?ell*o? worl\\ld\\\\\\d\d\d?", IntPtr.Zero);
            Console.WriteLine("폴더 만들기 결과 : {0}", result);
            Console.WriteLine("마지막 오류 코드 : {0}", GetLastError());
            Console.ReadKey(true);

        }
    }
}
```



이렇게 하면 마지막으로 발생한 오류의 코드가 출력이 됩니다.

여기서 오류 코드 123이 출력되는데 MSDN에 검색하면 다음과 같은 에러가 출력됩니다.

![1551146647737](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1551146647737.png)

하지만 일일이 MSDN사이트에 접속해서 오류코드를 확인하기 번거롭죠? 

이때 FormatMessage API를 추가하면 좀더 쉽게 오류코드를 메시지로 출력될수 있습니다.

##### -참고

FormatMessage Reference

```c#
[DllImport("kernel32", CharSet = CharSet.Auto)]
public static extern Int32 FormatMessage(Int32 dwFlags, IntPtr lpSource, Int32 dwMessageId, Int32 dwLanguageId, out String lpBuffer, Int32 dwSize, IntPtr lpArguments);
```

dwFlags : 메세지를 형식화 할때 사용될 옵션을 입력

lpSource : 메세지가 정의된 핸들을 입력

dwMessageId  : 메세지 번호를 입력합니다.

dwLanguageId  : 언어번호를 입력합니다.

lpBuffer  : 형식화된 메세지가 저장될 버퍼를 입력합니다.

dwSize  : 버퍼의 크기를 입력합니다.

lpArguments  : 매게변수를 입력합니다.

https://docs.microsoft.com/en-us/windows/desktop/api/winbase/nf-winbase-formatmessage



```c#
using System;
using System.Runtime.InteropServices;

namespace ApiReference
{
    class ApiExample
    {
        [DllImport("kernel32", CharSet = CharSet.Auto)]
        public static extern Int32 CreateDirectory(String PathName, IntPtr SecAttr);
        [DllImport("kernel32", CharSet = CharSet.Auto)]
        public static extern Int32 GetLastError();
        [DllImport("kernel32", CharSet = CharSet.Auto)]
        public static extern Int32 FormatMessage(Int32 dwFlags, IntPtr lpSource, Int32 dwMessageId, Int32 dwLanguageId, out String lpBuffer, Int32 dwSize, IntPtr lpArguments);

         public static void Main(String[] args)
        {
            Int32 result = CreateDirectory(@"C:\h?ell*o? worl\\ld\\\\\\d\d\d?", IntPtr.Zero);
            Console.WriteLine("폴더 만들기 결과 : {0}", result);
            Int32 lec = GetLastError();
            Console.WriteLine("마지막 오류 코드 : {0}", lec);
            Console.WriteLine("오류코드 설명 : {0}", GetErrorMessage(lec));
            Console.ReadKey(true);

        }
        public static String GetErrorMessage(Int32 errcode)
        {
            String errmsg;
            FormatMessage(0x1300, IntPtr.Zero, errcode, 0x400, out errmsg, 260, IntPtr.Zero);
            return errmsg;
        }
    }
}
```

출처 https://slaner.tistory.com/47





## -GetLastError와 WaitForSingleobject 사용 이유

### 1. getlasterror()

 	어떤 동작을 했는데 실패를 했습니다. 

​	그 실패한 원인을 알기 위해 호출하는 것입니다.

​	에러 코드를 error lockup 프로그램에 숫자를 넣으면 그 숫자에 해당하는 에러의 원인을 알려줍니다.

### 2. waitforsingleobject()

​	동기화를 위해서 사용합니다.

​	



## -윈도우 오류 처리

오류 처리

잘 작성된 응용 프로그램에는 예기치 않은 오류로 부터 정상적으로 복구 할 수 있는 오류 처리 코드가 포함됩니다. 오류가 발생하면 응용 프로그램이 사용자 개입을 요청해야하거나 자체적으로 복구 할 수 있습니다. 극단적인 경우 응용 프로그램에서 사용자를 로그 오프하거나 시스템을 종료 할수 있습니다.



오류 처리 정보

오류 처리 기능을 사용하면 응용 프로그램에 대한 오류 정보를 수신하고 표시할 수 있습니다. 

​	오류 모드 

응용프로그램이 심각한 오류에 응답하는 방법을 시스템에 표시합니다. 심각한 오류에는 디스크 오류, 드라이브가 준비되지 않은 오류, 데이터 오정렬 및 처리되지 않은 예외가 포함됩니다. 이 오류모드는 스레드 또는 프로세스 별로 관리 할 수 있습니다. 응용 프로그램은 시스템에 사용자에게 오류가 발생했음을 알리는 메시지 상자를 표시하거나 오류를 처리 할 수 있습니다. 

​	Last-Error Code

오류가 발생하면 대부분의 시스템 함수는 오류코드(0, NULL, -1)를 반환합니다.

또한 많은 시스템 기능이 마지막 오류 코드라는 추가적인 오류 코드를 설정합니다. 이 오류 코드는 실행중인 각 스레드 마다 별도로 유지 관리됩니다. 한 스레드의 오류가 다른 스레드의 마지막 오류 코드를 덮어 쓰지 않습니다. 모든 함수는 SetLastError 또는 SetLastErrorEx 함수를 호출하여 현재 스레드의 마지막 오류 코드를 설정할 수 있습니다. 이러한 함수는 주로 동적 연결 라이브러리(DLL)를 위한 것이므로 호출 응용 프로그램에 정보를 제공 할 수 있습니다. 일부 함수는 SetLastError 또는 SetLastErrorEx를 호출합니다. 

시스템은 마지막 오류 코드로 설정되거나 기능에 의해 리턴 될 수 있는 오류 코드 세트를 정의합니다. 오류 코드는 32비트 값입니다. 

​	-Notifying the User

MessageBeep 함수 : 사용자에게 오류가 발생했음을 알리기 위해 사용(사운드를 생성) 

​				      FlashWindow 또는 FlashwindowEx함수를 사용하여 창을 플래싱

​				      또한 응용 프로그램은 이러한 기능을 사용하여 오류에 주의를 환기 시키고 메시지를 표시

​	-Message Table

메시지 테이블은 오류 메시지를 표시 할 때 사용되는 특수 문자열 리소스 입니다. MESSAGETABLE자원 정의 문을 사용하여 자원 파일에서 선언됩니다. 메시지 문자열에 액세스하려면 FormatMessage 함수를 사용하면 되요~



​	-Fatal Application Exit

message box를 표시하고 사용자가 메시지 창을 닫고 프로그램을 종료합니다. 





### C# MessageBox Class

사용자에게 메시지를 보여주는 창을 표시합니다(대화상자)

이 창은 사용자가 닫을 때 까지 애플리케이션의 다른 동작을 차단하는 창.





### 